rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- HELPERS SEGUROS ---
    
    // 1. Verifica si el usuario existe en base de datos antes de leer
    function userExists() {
      return request.auth != null && exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    // 2. Obtiene datos de forma segura
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // 3. Verifica propiedad del negocio
    function isMyBusiness(docBusinessId) {
      return userExists() && getUserData().businessId == docBusinessId;
    }

    // --- COLECCIONES ---

    match /users/{userId} {
      // LEER: Permitir si es el mismo usuario O si es compañero de trabajo
      // (Usamos userExists() para evitar crash si el doc aun no se crea)
      allow read: if request.auth != null && (
        request.auth.uid == userId || 
        (resource.data.businessId != null && getUserData().businessId == resource.data.businessId)
      );
      
      // CREAR: Solo si el ID del documento coincide con el UID del usuario
      allow create: if request.auth != null && request.auth.uid == userId;
      
      allow update: if request.auth != null && request.auth.uid == userId;
    }

    match /businesses/{businessId} {
      allow read, update: if isMyBusiness(businessId);
      allow create: if request.auth != null; // Permitir crear negocio al registrarse
    }

    match /appointments/{id} {
      allow read, update, delete: if isMyBusiness(resource.data.businessId);
      allow create: if request.auth != null; // Permitir crear citas (validar businessId en backend idealmente)
    }

    // Regla comodín para colecciones simples del negocio
    match /{collection}/{id} {
      allow read, write: if (collection == 'clients' || collection == 'invoices' || collection == 'products') 
                         && isMyBusiness(resource.data.businessId);
    }
    
    // Servicios públicos
    match /services/{id} {
      allow read: if true;
      allow write: if isMyBusiness(resource.data.businessId);
    }

    // Notificaciones (Vital si el registro crea una bienvenida)
    match /notifications/{id} {
      allow read, write: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }
  }
}