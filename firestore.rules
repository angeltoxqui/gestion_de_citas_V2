rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =================================================================
    // FUNCIONES AUXILIARES
    // =================================================================

    // Verifica si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Verifica si el usuario es el dueño del documento (para users)
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Obtiene los datos del usuario actual desde la colección 'users'
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Verifica si el usuario pertenece al negocio especificado
    function belongsToBusiness(businessId) {
      return isAuthenticated() && 
        getUserData().businessId == businessId;
    }
    
    // Verifica roles específicos
    function hasRole(allowedRoles) {
      return isAuthenticated() && getUserData().role in allowedRoles;
    }

    // Validación básica para creación de citas públicas
    function isValidNewAppointment() {
      let data = request.resource.data;
      return data.keys().hasAll(['patientName', 'patientPhone', 'appointmentDate', 'source']) &&
             data.source == 'online' &&
             data.status == 'pending';
    }

    // =================================================================
    // REGLAS POR COLECCIÓN
    // =================================================================

    // 1. Usuarios (Colección Raíz Unificada)
    match /users/{userId} {
      // READ: Usuario puede leer su propio perfil, o cualquier perfil de su mismo negocio
      allow read: if isAuthenticated() && (
        request.auth.uid == userId || 
        belongsToBusiness(resource.data.businessId)
      );
      
      // CREATE: 
      // - Usuario puede crear su propio perfil (registro normal)
      // - Owner puede crear perfiles de equipo (invitaciones)
      allow create: if isAuthenticated() && (
        request.auth.uid == userId ||
        (hasRole(['owner']) && request.resource.data.businessId == getUserData().businessId)
      );
      
      // UPDATE:
      // - Usuario puede editar su propio perfil
      // - Owner puede editar miembros de su equipo
      allow update: if isAuthenticated() && (
        request.auth.uid == userId ||
        (hasRole(['owner']) && resource.data.businessId == getUserData().businessId)
      );
      
      // DELETE: Solo el owner puede eliminar miembros de su equipo (no a sí mismo)
      allow delete: if isAuthenticated() && 
        hasRole(['owner']) && 
        resource.data.businessId == getUserData().businessId &&
        resource.data.uid != request.auth.uid;
    }
    
    // Reglas legacy para staffData (bloquear completamente)
    match /staffData/{userId} {
       allow read, write: if false; 
    }

    // 2. Negocios (Arquitectura Multi-Tenant)
    match /businesses/{businessId} {
      
      // Regla base para el documento del negocio
      allow read: if belongsToBusiness(businessId);
      allow write: if belongsToBusiness(businessId) && hasRole(['owner']); 
      allow create: if isAuthenticated(); // Permitir crear negocio al registrarse

      // --- SUBCOLECCIONES ---

      // A. Citas (Appointments)
      match /appointments/{appointmentId} {
        allow read: if belongsToBusiness(businessId);
        allow create: if belongsToBusiness(businessId) || isValidNewAppointment();
        allow update, delete: if belongsToBusiness(businessId);
      }

      // B. Facturas (Invoices)
      match /invoices/{invoiceId} {
        allow read, write: if belongsToBusiness(businessId);
      }

      // C. Clientes (Patients/Clients)
      match /clients/{clientId} {
         allow read, write: if belongsToBusiness(businessId);
      }
      
      match /patients/{patientId} {
         allow read, write: if belongsToBusiness(businessId);
      }

      // D. Servicios y Productos
      match /services/{serviceId} {
        allow read: if true; 
        allow write: if belongsToBusiness(businessId);
      }
      
      match /products/{productId} {
        allow read, write: if belongsToBusiness(businessId);
      }

      // E. Recetas
      match /prescriptions/{prescriptionId} {
        allow read, write: if belongsToBusiness(businessId);
      }
      
      // F. Pagos
      match /payments/{paymentId} {
        allow read, write: if belongsToBusiness(businessId);
      }

      // G. Notas de Cliente
      match /clientNotes/{noteId} {
        allow read, write: if belongsToBusiness(businessId);
      }
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
